<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Counselor Dashboard - MentalSpace</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .admin-bg {
            background: linear-gradient(135deg, #F8F8FF 0%, #F5F5DC 50%, #E6E6FA 100%);
        }
        .session-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .session-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        .online-indicator {
            width: 8px;
            height: 8px;
            background: #10B981;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        .priority-high { border-left: 4px solid #EF4444; }
        .priority-medium { border-left: 4px solid #F59E0B; }
        .priority-low { border-left: 4px solid #10B981; }
        .priority-emergency { border-left: 4px solid #DC2626; }
        .chat-message {
            max-width: 85%;
            word-wrap: break-word;
        }
        .user-message {
            background: linear-gradient(135deg, #8FBC8F, #E6E6FA);
            margin-left: auto;
        }
        .counselor-message {
            background: white;
            border: 1px solid #E5E7EB;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background: white;
            border: 1px solid #E5E7EB;
            border-radius: 1rem;
            margin-bottom: 0.5rem;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #9CA3AF;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="admin-bg min-h-screen">
    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-sm border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-purple-400 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-semibold text-gray-800">Counselor Dashboard</h1>
                    <p class="text-sm text-gray-600">MentalSpace Professional Portal</p>
                </div>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <div class="online-indicator"></div>
                    <span class="text-sm text-gray-600">Online</span>
                </div>
                <button onclick="logout()" class="p-2 rounded-full hover:bg-gray-100">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <div class="flex">
        <!-- Sidebar -->
        <div class="w-64 bg-white/60 backdrop-blur-sm border-r border-gray-200 min-h-screen">
            <nav class="p-6">
                <div class="space-y-2">
                    <button onclick="showDashboard()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg bg-gradient-to-r from-green-400 to-purple-400 text-white">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2-2z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5a2 2 0 012-2h4a2 2 0 012 2v6H8V5z"></path>
                        </svg>
                        <span class="font-medium">Dashboard</span>
                    </button>
                    <button onclick="showSessions()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                        </svg>
                        <span class="font-medium">Sessions</span>
                        <span id="sessionCount" class="ml-auto bg-red-100 text-red-800 text-xs px-2 py-1 rounded-full">0</span>
                    </button>
                    <button onclick="showAnalytics()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        <span class="font-medium">Analytics</span>
                    </button>
                    <button onclick="showProfile()" class="w-full flex items-center space-x-3 px-4 py-3 rounded-lg hover:bg-gray-100 text-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                        </svg>
                        <span class="font-medium">Profile</span>
                    </button>
                </div>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-6">
            <!-- Dashboard View -->
            <div id="dashboardView" class="space-y-6">
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Active Sessions</p>
                                <p id="activeSessionsCount" class="text-2xl font-bold text-blue-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Waiting Clients</p>
                                <p id="waitingClientsCount" class="text-2xl font-bold text-orange-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Sessions Today</p>
                                <p id="sessionsTodayCount" class="text-2xl font-bold text-green-600">0</p>
                            </div>
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-600">Average Rating</p>
                                <p id="averageRating" class="text-2xl font-bold text-purple-600">0.0</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                                <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z"></path>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-4">Quick Actions</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <button onclick="setAvailable()" class="p-4 bg-green-100 text-green-700 rounded-lg hover:bg-green-200 transition-colors">
                            <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium">Available</span>
                        </button>
                        <button onclick="setBusy()" class="p-4 bg-yellow-100 text-yellow-700 rounded-lg hover:bg-yellow-200 transition-colors">
                            <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span class="font-medium">Busy</span>
                        </button>
                        <button onclick="setOffline()" class="p-4 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                            <svg class="w-6 h-6 mx-auto mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path>
                            </svg>
                            <span class="font-medium">Offline</span>
                        </button>
                    </div>
                </div>

                <!-- Recent Sessions -->
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold text-gray-800">Recent Sessions</h2>
                        <button onclick="showSessions()" class="text-sm text-blue-600 hover:text-blue-700">View All</button>
                    </div>
                    <div id="recentSessions" class="space-y-3">
                        <!-- Sessions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Sessions View -->
            <div id="sessionsView" class="hidden space-y-6">
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-lg font-semibold text-gray-800">Active Sessions</h2>
                        <div class="flex items-center space-x-2">
                            <select id="priorityFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All Priorities</option>
                                <option value="emergency">Emergency</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                            <select id="statusFilter" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All Status</option>
                                <option value="waiting">Waiting</option>
                                <option value="active">Active</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                    </div>
                    <div id="activeSessions" class="space-y-4">
                        <!-- Active sessions will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Chat View -->
            <div id="chatView" class="hidden">
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl shadow-lg h-[600px] flex">
                    <!-- Chat Sidebar -->
                    <div class="w-80 border-r border-gray-200 p-4">
                        <h3 class="font-semibold text-gray-800 mb-4">Active Chats</h3>
                        <div id="chatList" class="space-y-2">
                            <!-- Chat list will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Chat Area -->
                    <div class="flex-1 flex flex-col">
                        <div class="p-4 border-b border-gray-200">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-blue-400 rounded-full flex items-center justify-center">
                                    <span id="currentUserInitial" class="text-white font-medium">U</span>
                                </div>
                                <div>
                                    <h3 id="currentUserName" class="font-semibold text-gray-800">Select a chat</h3>
                                    <p id="currentUserStatus" class="text-sm text-gray-500">Choose a session to start</p>
                                </div>
                            </div>
                        </div>
                        
                        <div id="chatMessages" class="flex-1 p-4 overflow-y-auto">
                            <div class="text-center text-gray-500 py-8">
                                <svg class="w-12 h-12 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path>
                                </svg>
                                <p>Select a session to start chatting</p>
                            </div>
                        </div>
                        
                        <div class="p-4 border-t border-gray-200">
                            <div class="flex items-end space-x-3">
                                <textarea 
                                    id="messageInput" 
                                    placeholder="Type your message..."
                                    class="flex-1 p-3 rounded-lg border border-gray-200 bg-white resize-none text-sm"
                                    rows="1"
                                    disabled
                                ></textarea>
                                <button id="sendButton" onclick="sendMessage()" class="p-3 rounded-full bg-gradient-to-r from-green-400 to-purple-400 text-white hover:opacity-90 transition-opacity" disabled>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analytics View -->
            <div id="analyticsView" class="hidden space-y-6">
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-6">Session Analytics</h2>
                    <div id="analyticsChart" style="height: 400px;"></div>
                </div>
            </div>

            <!-- Profile View -->
            <div id="profileView" class="hidden space-y-6">
                <div class="bg-white/60 backdrop-blur-sm rounded-2xl p-6 shadow-lg">
                    <h2 class="text-lg font-semibold text-gray-800 mb-6">Profile Settings</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Name</label>
                            <input type="text" id="counselorName" class="w-full p-3 border border-gray-200 rounded-lg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="counselorEmail" class="w-full p-3 border border-gray-200 rounded-lg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">License Number</label>
                            <input type="text" id="counselorLicense" class="w-full p-3 border border-gray-200 rounded-lg" readonly>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Specializations</label>
                            <input type="text" id="counselorSpecializations" class="w-full p-3 border border-gray-200 rounded-lg" readonly>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-white/60 backdrop-blur-sm border-t border-gray-200 px-6 py-4 mt-8">
        <div class="text-center text-sm text-gray-600">
            <p>&copy; 2024 MentalSpace. Professional Counselor Dashboard.</p>
        </div>
    </footer>

    <script>
        // Counselor Dashboard JavaScript
        let currentCounselor = null;
        let activeSessions = [];
        let currentChatSession = null;
        let socket = null;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            initializeDashboard();
        });

        async function initializeDashboard() {
            try {
                // Check if user is authenticated as counselor
                const token = localStorage.getItem('mentalspace_token');
                if (!token) {
                    window.location.href = 'index.html';
                    return;
                }

                // Load counselor data
                await loadCounselorData();
                
                // Load dashboard data
                await loadDashboardData();
                
                // Initialize real-time connection
                initializeRealTimeConnection();
                
                // Show dashboard by default
                showDashboard();
                
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                if (error.message.includes('Unauthorized')) {
                    localStorage.removeItem('mentalspace_token');
                    window.location.href = 'index.html';
                }
            }
        }

        async function loadCounselorData() {
            try {
                const response = await fetch('/api/counselors/profile', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mentalspace_token')}`
                    }
                });
                
                if (!response.ok) throw new Error('Failed to load counselor data');
                
                currentCounselor = await response.json();
                updateCounselorProfile();
            } catch (error) {
                console.error('Failed to load counselor data:', error);
                throw error;
            }
        }

        function updateCounselorProfile() {
            if (!currentCounselor) return;
            
            document.getElementById('counselorName').value = `${currentCounselor.firstName} ${currentCounselor.lastName}`;
            document.getElementById('counselorEmail').value = currentCounselor.email;
            document.getElementById('counselorLicense').value = currentCounselor.licenseNumber;
            document.getElementById('counselorSpecializations').value = currentCounselor.specializations?.join(', ') || '';
        }

        async function loadDashboardData() {
            try {
                // Load active sessions
                const sessionsResponse = await fetch('/api/counselor/sessions', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mentalspace_token')}`
                    }
                });
                
                if (sessionsResponse.ok) {
                    const sessionsData = await sessionsResponse.json();
                    activeSessions = sessionsData.sessions || [];
                    updateDashboardStats();
                    updateSessionsList();
                }
            } catch (error) {
                console.error('Failed to load dashboard data:', error);
            }
        }

        function updateDashboardStats() {
            const activeCount = activeSessions.filter(s => s.status === 'active').length;
            const waitingCount = activeSessions.filter(s => s.status === 'waiting').length;
            const todayCount = activeSessions.filter(s => {
                const today = new Date().toDateString();
                return new Date(s.startedAt).toDateString() === today;
            }).length;
            
            const ratings = activeSessions.filter(s => s.rating).map(s => s.rating);
            const averageRating = ratings.length > 0 ? (ratings.reduce((a, b) => a + b, 0) / ratings.length).toFixed(1) : '0.0';
            
            document.getElementById('activeSessionsCount').textContent = activeCount;
            document.getElementById('waitingClientsCount').textContent = waitingCount;
            document.getElementById('sessionsTodayCount').textContent = todayCount;
            document.getElementById('averageRating').textContent = averageRating;
            document.getElementById('sessionCount').textContent = waitingCount;
        }

        function updateSessionsList() {
            const container = document.getElementById('recentSessions');
            const activeSessionsContainer = document.getElementById('activeSessions');
            
            // Update recent sessions (dashboard view)
            const recentSessions = activeSessions.slice(0, 5);
            container.innerHTML = recentSessions.map(session => `
                <div class="session-card p-4 bg-white rounded-lg border border-gray-200" onclick="openChat('${session.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-blue-400 rounded-full flex items-center justify-center">
                                <span class="text-white font-medium">${session.user?.firstName?.[0] || 'U'}</span>
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${session.user?.firstName || 'Anonymous User'}</p>
                                <p class="text-sm text-gray-600">${session.topic || 'General Support'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="priority-${session.priority} px-2 py-1 text-xs rounded-full">${session.priority}</span>
                            <p class="text-xs text-gray-500 mt-1">${formatTime(session.startedAt)}</p>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 text-center py-4">No recent sessions</p>';
            
            // Update active sessions (sessions view)
            activeSessionsContainer.innerHTML = activeSessions.map(session => `
                <div class="session-card p-4 bg-white rounded-lg border border-gray-200 priority-${session.priority}" onclick="openChat('${session.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-gradient-to-br from-green-400 to-blue-400 rounded-full flex items-center justify-center">
                                <span class="text-white font-medium">${session.user?.firstName?.[0] || 'U'}</span>
                            </div>
                            <div>
                                <h3 class="font-semibold text-gray-800">${session.user?.firstName || 'Anonymous User'}</h3>
                                <p class="text-sm text-gray-600">${session.topic || 'General Support'}</p>
                                <p class="text-xs text-gray-500">${session.description || 'No description provided'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-block px-3 py-1 text-xs rounded-full ${getStatusColor(session.status)}">${session.status}</span>
                            <p class="text-xs text-gray-500 mt-1">${formatTime(session.startedAt)}</p>
                            <p class="text-xs text-gray-500">Priority: ${session.priority}</p>
                        </div>
                    </div>
                </div>
            `).join('') || '<p class="text-gray-500 text-center py-8">No active sessions</p>';
        }

        function getStatusColor(status) {
            switch(status) {
                case 'active': return 'bg-green-100 text-green-800';
                case 'waiting': return 'bg-yellow-100 text-yellow-800';
                case 'closed': return 'bg-gray-100 text-gray-800';
                default: return 'bg-blue-100 text-blue-800';
            }
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h ago`;
            return date.toLocaleDateString();
        }

        // View navigation
        function showDashboard() {
            hideAllViews();
            document.getElementById('dashboardView').classList.remove('hidden');
            updateSidebarActive('dashboard');
        }

        function showSessions() {
            hideAllViews();
            document.getElementById('sessionsView').classList.remove('hidden');
            updateSidebarActive('sessions');
        }

        function showChat() {
            hideAllViews();
            document.getElementById('chatView').classList.remove('hidden');
            updateSidebarActive('chat');
        }

        function showAnalytics() {
            hideAllViews();
            document.getElementById('analyticsView').classList.remove('hidden');
            updateSidebarActive('analytics');
            initializeAnalyticsChart();
        }

        function showProfile() {
            hideAllViews();
            document.getElementById('profileView').classList.remove('hidden');
            updateSidebarActive('profile');
        }

        function hideAllViews() {
            const views = ['dashboardView', 'sessionsView', 'chatView', 'analyticsView', 'profileView'];
            views.forEach(view => {
                document.getElementById(view).classList.add('hidden');
            });
        }

        function updateSidebarActive(active) {
            const buttons = document.querySelectorAll('nav button');
            buttons.forEach(button => {
                button.classList.remove('bg-gradient-to-r', 'from-green-400', 'to-purple-400', 'text-white');
                button.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            
            const activeButton = document.querySelector(`nav button[onclick*="${active}"]`);
            if (activeButton) {
                activeButton.classList.remove('hover:bg-gray-100', 'text-gray-700');
                activeButton.classList.add('bg-gradient-to-r', 'from-green-400', 'to-purple-400', 'text-white');
            }
        }

        // Chat functionality
        async function openChat(sessionId) {
            const session = activeSessions.find(s => s.id === sessionId);
            if (!session) return;
            
            currentChatSession = session;
            showChat();
            
            // Update chat header
            document.getElementById('currentUserName').textContent = session.user?.firstName || 'Anonymous User';
            document.getElementById('currentUserStatus').textContent = `${session.status} â€¢ ${session.priority} priority`;
            document.getElementById('currentUserInitial').textContent = session.user?.firstName?.[0] || 'U';
            
            // Enable message input
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendButton').disabled = false;
            
            // Load messages
            await loadChatMessages(sessionId);
            
            // Join chat room
            if (socket) {
                socket.emit('chat:join', sessionId);
            }
        }

        async function loadChatMessages(sessionId) {
            try {
                const response = await fetch(`/api/chat/sessions/${sessionId}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('mentalspace_token')}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayChatMessages(data.messages);
                }
            } catch (error) {
                console.error('Failed to load chat messages:', error);
            }
        }

        function displayChatMessages(messages) {
            const container = document.getElementById('chatMessages');
            container.innerHTML = messages.map(message => {
                const isOwn = message.senderType === 'counselor';
                const messageClass = isOwn ? 'counselor-message' : 'user-message';
                const textColor = isOwn ? 'text-gray-800' : 'text-white';
                
                return `
                    <div class="chat-message ${messageClass} rounded-2xl px-4 py-3 shadow-sm mb-2 ${textColor}">
                        <p class="text-sm">${message.message}</p>
                        <span class="text-xs ${isOwn ? 'text-gray-500' : 'text-white/80'} mt-1 block">${formatTime(message.sentAt)}</span>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            if (!currentChatSession) return;
            
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message) return;
            
            try {
                const response = await fetch(`/api/chat/sessions/${currentChatSession.id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mentalspace_token')}`
                    },
                    body: JSON.stringify({ message })
                });
                
                if (response.ok) {
                    input.value = '';
                    await loadChatMessages(currentChatSession.id);
                    
                    // Send via socket.io for real-time delivery
                    if (socket) {
                        socket.emit('chat:message', {
                            sessionId: currentChatSession.id,
                            message
                        });
                    }
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        // Status management
        async function setAvailable() {
            await updateCounselorStatus('available');
        }

        async function setBusy() {
            await updateCounselorStatus('busy');
        }

        async function setOffline() {
            await updateCounselorStatus('offline');
        }

        async function updateCounselorStatus(status) {
            try {
                const response = await fetch('/api/counselors/status', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('mentalspace_token')}`
                    },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    showSuccessMessage(`Status updated to ${status}`);
                }
            } catch (error) {
                console.error('Failed to update status:', error);
                showErrorMessage('Failed to update status');
            }
        }

        // Real-time connection
        function initializeRealTimeConnection() {
            const token = localStorage.getItem('mentalspace_token');
            if (!token) return;
            
            socket = io('http://localhost:3001', {
                auth: { token }
            });
            
            socket.on('connect', () => {
                console.log('Connected to real-time server');
            });
            
            socket.on('new-session', (data) => {
                showSuccessMessage('New client session available');
                loadDashboardData();
            });
            
            socket.on('disconnect', () => {
                console.log('Disconnected from real-time server');
            });
        }

        // Analytics
        function initializeAnalyticsChart() {
            const chartElement = document.getElementById('analyticsChart');
            if (!chartElement) return;
            
            const chart = echarts.init(chartElement);
            
            // Sample data - in real app, this would come from API
            const option = {
                title: {
                    text: 'Session Analytics',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'axis'
                },
                legend: {
                    data: ['Sessions', 'Average Rating'],
                    bottom: 0
                },
                xAxis: {
                    type: 'category',
                    data: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun']
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Sessions',
                        position: 'left'
                    },
                    {
                        type: 'value',
                        name: 'Rating',
                        position: 'right',
                        min: 0,
                        max: 5
                    }
                ],
                series: [
                    {
                        name: 'Sessions',
                        type: 'bar',
                        data: [5, 8, 12, 7, 10, 6, 4],
                        itemStyle: {
                            color: '#8FBC8F'
                        }
                    },
                    {
                        name: 'Average Rating',
                        type: 'line',
                        yAxisIndex: 1,
                        data: [4.2, 4.5, 4.8, 4.3, 4.6, 4.1, 3.9],
                        itemStyle: {
                            color: '#E6E6FA'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
        }

        // Utility functions
        function logout() {
            localStorage.removeItem('mentalspace_token');
            if (socket) {
                socket.disconnect();
            }
            window.location.href = 'index.html';
        }

        function showSuccessMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-6 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function showErrorMessage(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-20 right-6 bg-red-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }
    </script>
</body>
</html>